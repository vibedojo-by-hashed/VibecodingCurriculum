# Chapter 18: 아키텍처 이해

[English](./README.md) | **한국어**

## 이 챕터에서 배우는 것

- Claude Code가 어떻게 작동하는지
- 도구 시스템 이해하기
- 이 지식을 활용해 더 잘 요청하기

---

## 왜 아키텍처를 알아야 할까?

Claude Code를 "마법의 도구"로 생각하면 한계가 있습니다. 작동 원리를 이해하면:

- **더 정확한 요청**: 어떤 도구가 사용될지 예측 가능
- **문제 해결**: 왜 안 되는지 스스로 파악 가능
- **효율적 사용**: 불필요한 작업 줄이기

---

## Claude Code의 전체 구조

### 한 눈에 보기

```
┌─────────────────────────────────────────────────────────────────┐
│                        여러분 (터미널)                           │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Claude Code CLI                            │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────────┐    │
│  │ 입력 처리     │  │ 도구 실행 엔진 │  │  출력 렌더러       │    │
│  └───────────────┘  └───────────────┘  └───────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Anthropic API (Claude)                        │
│               모델: opus / sonnet / haiku 선택 가능              │
└─────────────────────────────────────────────────────────────────┘
```

**핵심 포인트**: Claude는 여러분의 컴퓨터에서 직접 실행되지 않습니다. API를 통해 대화하고, 도구 실행만 로컬에서 일어납니다.

### API 통신 사이클

요청을 하면 어떤 일이 일어나는지 봅시다:

```
 [1] 여러분의 요청                    [2] API로 전송
      │                                 │
      ▼                                 ▼
┌──────────┐    메시지 + 도구 정의    ┌─────────────┐
│ CLI      │ ─────────────────────▶ │ Anthropic   │
│ Client   │                        │ API         │
└──────────┘                        └─────────────┘
      ▲                                 │
      │     응답 (텍스트 + 도구 호출)     │
      └─────────────────────────────────┘
                    [3]

 [4] 로컬에서 도구 실행               [5] 결과 다시 API로
      │                                 │
      ▼                                 ▼
┌──────────────────┐              ┌─────────────┐
│ Bash, Read 등    │ ───────────▶ │ Claude가    │
│ 실행             │              │ 다음 판단   │
└──────────────────┘              └─────────────┘
```

### 이걸 알면 뭐가 좋을까?

```
> 이 폴더의 모든 파일 보여줘
```

이 요청을 하면:
1. Claude가 `Glob` 도구로 파일 목록 조회 → API 왕복 1번
2. 결과를 받아서 다음 행동 결정 → API 왕복 2번
3. 필요하면 `Read`로 파일 내용 확인 → API 왕복 3번

**한 번의 요청 = 여러 번의 API 왕복**이 될 수 있습니다. 그래서 구체적으로 요청하면 왕복 횟수가 줄어들고 더 빠릅니다.

---

## 도구 시스템

Claude Code는 18개의 내장 도구를 사용합니다.

### 도구 분류

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              도구 실행 레이어                                │
│                                                                             │
│  파일 작업 ─────────────────────────────────────────────────────────────    │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐              │
│  │  Read   │ │  Write  │ │  Edit   │ │  Glob   │ │  Grep   │              │
│  │ 파일읽기 │ │ 파일생성 │ │ 파일수정 │ │ 파일검색 │ │ 내용검색 │              │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘              │
│                                                                             │
│  실행 ──────────────────────────────────────────────────────────────────    │
│  ┌─────────┐ ┌─────────────────┐                                           │
│  │  Bash   │ │     Task        │                                           │
│  │ 명령실행 │ │ (서브에이전트)   │                                           │
│  └─────────┘ └─────────────────┘                                           │
│                                                                             │
│  웹 ────────────────────────────────────────────────────────────────────    │
│  ┌─────────┐ ┌─────────┐                                                   │
│  │WebFetch │ │WebSearch│                                                   │
│  │URL 가져오기│ │웹 검색  │                                                   │
│  └─────────┘ └─────────┘                                                   │
│                                                                             │
│  기타 ──────────────────────────────────────────────────────────────────    │
│  ┌─────────┐ ┌─────────┐ ┌───────────────┐ ┌───────────────┐              │
│  │TodoWrite│ │  Skill  │ │ EnterPlanMode │ │AskUserQuestion│              │
│  │작업관리  │ │스킬 실행 │ │  계획 모드     │ │ 사용자 질문    │              │
│  └─────────┘ └─────────┘ └───────────────┘ └───────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 도구 실행 흐름

도구가 호출되면 이런 흐름으로 처리됩니다:

```
    Claude 응답
         │
         ▼
  ┌──────────────┐
  │ 응답 파싱    │
  │ (텍스트 +    │
  │  도구 호출)  │
  └──────┬───────┘
         │
    ┌────┴────┐
    ▼         ▼
┌────────┐ ┌────────┐
│ 텍스트 │ │ 도구   │
│ 출력   │ │ 실행   │
└────────┘ └───┬────┘
               │
         ┌─────┴─────┐
         ▼           ▼
    ┌────────┐  ┌────────┐
    │ 성공   │  │ 실패   │
    │ 결과   │  │ 에러   │
    └───┬────┘  └───┬────┘
        │           │
        └─────┬─────┘
              ▼
    ┌─────────────────┐
    │ API에 결과 전송  │
    │ (다음 턴 시작)   │
    └─────────────────┘
```

### 이걸 알면 뭐가 좋을까?

**요청 방식에 따라 사용되는 도구가 다릅니다:**

```
# Glob 사용 (빠름)
> src 폴더에 tsx 파일이 몇 개야?

# Bash 사용 (불필요하게 복잡)
> find 명령어로 src 폴더에서 tsx 파일 개수 세줘
```

Claude Code의 전용 도구가 있는 작업은 그 도구를 쓰게 요청하는 게 효율적입니다.

---

## 서브에이전트 시스템

복잡한 작업은 여러 "서브에이전트"로 나뉘어 실행됩니다.

### 서브에이전트 아키텍처

```
                          ┌─────────────────┐
                          │   메인 에이전트  │
                          │   (여러분과 대화) │
                          └────────┬────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
         ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
         │   Task 1     │ │   Task 2     │ │   Task 3     │
         │  (탐색)      │ │  (분석)      │ │  (실행)      │
         └──────────────┘ └──────────────┘ └──────────────┘
```

### 서브에이전트 타입

| 타입 | 용도 | 사용 가능 도구 | 특징 |
|------|------|---------------|------|
| `Explore` | 코드베이스 탐색 | Read, Glob, Grep | 읽기 전용 |
| `Plan` | 계획 수립 | Read, Glob, Grep | 읽기 전용 |
| `Bash` | 명령어 전문 | Bash만 | Git 작업 등 |
| `general-purpose` | 복잡한 작업 | 모든 도구 | 만능형 |

### 병렬 vs 순차 실행

```
병렬 실행 (독립적인 작업들):
─────────────────────────────────────────────
    ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ Agent A  │     │ Agent B  │     │ Agent C  │
    │ (검색1)  │     │ (검색2)  │     │ (검색3)  │
    └────┬─────┘     └────┬─────┘     └────┬─────┘
         │                │                │
         └────────────────┼────────────────┘
                          │
                          ▼
                   ┌──────────────┐
                   │ 결과 통합     │
                   └──────────────┘

순차 실행 (의존적인 작업들):
─────────────────────────────────────────────
    ┌──────────┐     ┌──────────┐     ┌──────────┐
    │ Agent A  │ ──▶ │ Agent B  │ ──▶ │ Agent C  │
    │ (분석)   │     │ (A결과   │     │ (B결과   │
    │          │     │  사용)   │     │  사용)   │
    └──────────┘     └──────────┘     └──────────┘
```

### 이걸 알면 뭐가 좋을까?

**큰 작업을 요청하면 자동으로 분리됩니다:**

```
> 이 프로젝트 전체 분석하고 리팩토링 계획 세워줘
```

내부적으로:
1. `Explore` 에이전트가 프로젝트 구조 파악
2. `Plan` 에이전트가 계획 수립
3. 메인 에이전트가 결과 종합

**작업을 미리 나눠서 요청하면 더 정확합니다:**

```
# 한 번에 다 하기 (에이전트가 알아서 나눔)
> 프로젝트 분석하고 리팩토링해줘

# 단계별로 나누기 (더 정확한 제어)
> 먼저 프로젝트 구조만 분석해줘
> (결과 확인 후)
> 이 부분 리팩토링 계획 세워줘
> (계획 확인 후)
> 좋아, 실행해줘
```

---

## 모델 선택

Claude Code는 여러 모델을 지원합니다.

| 모델 | 특징 | 언제 사용 |
|------|------|----------|
| **Opus** | 가장 똑똑함, 비용 높음 | 복잡한 설계, 어려운 버그 |
| **Sonnet** | 균형잡힌 성능 | 일반적인 작업 (기본값) |
| **Haiku** | 빠르고 저렴 | 간단한 작업, 반복 작업 |

### 실용적인 전략

```
# 계획 단계: 똑똑한 모델로
> /model opus
> 이 시스템 어떻게 설계하면 좋을까?

# 구현 단계: 빠른 모델로
> /model sonnet
> 위 계획대로 구현해줘
```

**비용 vs 품질 트레이드오프**를 상황에 맞게 조절할 수 있습니다.

---

## 컨텍스트 관리

### 대화가 길어지면 품질이 떨어집니다

Claude는 한 번에 처리할 수 있는 정보량에 한계가 있습니다. 대화가 길어지면:
- 초반 내용을 잘 기억 못함
- 전체 맥락 파악이 흐려짐
- 응답 품질 저하

### 해결 방법

**1. /compact로 압축**
```
> /compact
```
지금까지의 대화를 요약해서 토큰을 절약합니다.

**2. 주제별로 대화 분리**
```
# 한 대화에서 다 하기 (맥락이 섞임)
> 인증 기능 만들어줘
> DB 스키마도 수정해줘
> 프론트엔드 폼도 만들어줘

# 주제별로 나누기 (더 집중)
> /clear
> 인증 기능에 집중하자. 백엔드 API 먼저 만들어줘.
```

**3. CLAUDE.md 활용**

CLAUDE.md는 `/clear` 후에도 유지됩니다. 프로젝트 규칙을 여기에 적어두면 대화를 새로 시작해도 컨텍스트가 보존됩니다.

---

## 권한과 보안

### 보안 정책 흐름

```
  사용자 요청
       │
       ▼
┌──────────────┐    아니오     ┌──────────────┐
│ 위험한 작업? │ ────────────▶ │ 바로 실행    │
└──────┬───────┘               └──────────────┘
       │ 예
       ▼
┌──────────────┐    거부       ┌──────────────┐
│ 사용자 승인  │ ────────────▶ │ 작업 취소    │
│ 요청         │               └──────────────┘
└──────┬───────┘
       │ 승인
       ▼
┌──────────────┐
│ 샌드박스에서 │
│ 실행         │
└──────────────┘
```

### 왜 승인을 요청할까?

Claude Code는 위험할 수 있는 작업 전에 승인을 요청합니다:
- 파일 수정/삭제
- 명령어 실행
- 외부 API 호출

### 자동 승인 설정

자주 쓰는 안전한 도구는 자동 승인할 수 있습니다:

```json
// settings.json
{
  "permissions": {
    "autoApprove": ["Read", "Glob", "Grep"]
  }
}
```

**주의**: `Edit`, `Write`, `Bash`는 신중하게 설정하세요.

### 샌드박스 모드

Bash 명령은 기본적으로 샌드박스에서 실행됩니다. 시스템을 보호하면서 작업할 수 있습니다.

---

## 실용적인 팁

### 1. 도구를 명시적으로 언급

```
# 암시적 (Claude가 추론해야 함)
> 이 프로젝트에서 에러 처리 어떻게 되어있어?

# 명시적 (더 빠름)
> grep으로 "catch" 키워드 검색해서 에러 처리 패턴 보여줘
```

### 2. 한 번에 하나씩

```
# 여러 작업 한꺼번에 (혼란 가능)
> 파일 만들고, 테스트 작성하고, 커밋해줘

# 단계별로 (더 정확)
> 파일 먼저 만들어줘
> (확인 후) 테스트 작성해줘
> (확인 후) 커밋해줘
```

### 3. 결과 확인 후 진행

Claude가 파일을 수정했다면 결과를 확인한 후 다음 단계로 진행하세요. 중간에 잘못된 게 있으면 바로 수정할 수 있습니다.

---

## 정리

이번 챕터에서 배운 것:
- [x] Claude Code의 전체 아키텍처와 API 통신 흐름
- [x] 18개 내장 도구 시스템
- [x] 서브에이전트 작동 방식과 병렬 실행
- [x] 모델 선택과 컨텍스트 관리
- [x] 권한과 보안 정책

**핵심 포인트**: Claude Code는 마법이 아니라 시스템입니다. 시스템을 이해하면 더 잘 활용할 수 있습니다.

다음 챕터에서는 이 시스템을 커스터마이징하는 방법을 배웁니다.

[Chapter 19: 설정 심화](../Chapter19/README.ko.md)로 넘어가세요.
